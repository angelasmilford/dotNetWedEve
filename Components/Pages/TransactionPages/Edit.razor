@page "/transactions/edit"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Forms
@using dotNetWedEve
@inject IDbContextFactory<dotNetWedEveContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Edit</PageTitle>

<h1>Edit</h1>

<h2>Transaction</h2>
<hr />
@if (Transaction is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <EditForm method="post" Model="Transaction" OnValidSubmit="UpdateTransaction" FormName="edit" Enhance>
                <DataAnnotationsValidator />
                <ValidationSummary role="alert"/>
                <input type="hidden" name="Transaction.Id" value="@Transaction.Id" />
                <div class="mb-3">
                    <label for="name" class="form-label">Name:</label>
                    <InputText id="name" @bind-Value="Transaction.Name" class="form-control" />
                    <ValidationMessage For="() => Transaction.Name" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="amount" class="form-label">Amount:</label>
                    <InputNumber id="amount" @bind-Value="Transaction.Amount" class="form-control" />
                    <ValidationMessage For="() => Transaction.Amount" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="type" class="form-label">Type:</label>
                    <InputSelect id="type" @bind-Value="Transaction.Type" class="form-control">
                        @foreach (TransactionType t in Enum.GetValues(typeof(TransactionType)))
                        {
                            <option value="@t">@t</option>
                        }
                    </InputSelect>
                    <ValidationMessage For="() => Transaction.Type" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="date" class="form-label">Date:</label>
                    <InputDate id="date" @bind-Value="Transaction.Date" class="form-control" />
                    <ValidationMessage For="() => Transaction.Date" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Notes:</label>
                    <InputText id="notes" @bind-Value="Transaction.Notes" class="form-control" />
                    <ValidationMessage For="() => Transaction.Notes" class="text-danger" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Category:</label>
                    <InputSelect @bind-Value="SelectedCategoryId" class="form-select">
                        <option value="">-- Select category --</option>
                        @foreach (var c in Categories)
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    </InputSelect>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </EditForm>
        </div>
    </div>
}

<div>
    <a href="/transactions">Back to List</a>
</div>

@code {
    [SupplyParameterFromQuery]
    private int Id { get; set; }

    private Transaction? Transaction { get; set; }

    // Category UI state
    private List<Category> Categories { get; set; } = new List<Category>();
    private int? SelectedCategoryId { get; set; }
    private bool IsAddingNewCategory { get; set; } = false;
    private string NewCategoryName { get; set; } = string.Empty;
    private string NewCategoryColor { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Transaction ??= await context.Transaction
            .Include(t => t.Category)
            .FirstOrDefaultAsync(m => m.Id == Id);

        if (Transaction is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Load available categories and set the selected one from the transaction
        Categories = await context.Category.OrderBy(c => c.Name).ToListAsync();
        SelectedCategoryId = Transaction.Category?.Id;
    }

    // To protect from overposting attacks, enable the specific properties you want to bind to.
    // For more information, see https://learn.microsoft.com/aspnet/core/blazor/forms/#mitigate-overposting-attacks.
    private async Task UpdateTransaction()
    {
        using var context = DbFactory.CreateDbContext();

        // Load the tracked entity from the DB and update its properties to avoid attach-related issues
        var dbTrans = await context.Transaction.Include(t => t.Category).FirstOrDefaultAsync(t => t.Id == Transaction!.Id);
        if (dbTrans is null)
        {
            NavigationManager.NavigateTo("notfound");
            return;
        }

        // Update scalar properties
        dbTrans.Name = Transaction!.Name;
        dbTrans.Amount = Transaction.Amount;
        dbTrans.Type = Transaction.Type;
        dbTrans.Date = Transaction.Date;
        dbTrans.Notes = Transaction.Notes;

        // Handle category assignment (new or existing)
        if (IsAddingNewCategory && !string.IsNullOrWhiteSpace(NewCategoryName))
        {
            var newCat = new Category { Name = NewCategoryName.Trim(), Color = NewCategoryColor ?? string.Empty };
            context.Category.Add(newCat);
            await context.SaveChangesAsync();
            dbTrans.Category = newCat;
        }
        else if (SelectedCategoryId.HasValue)
        {
            var existing = await context.Category.FindAsync(SelectedCategoryId.Value);
            if (existing != null)
            {
                dbTrans.Category = existing;
            }
        }

        try
        {
            await context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!TransactionExists(Transaction!.Id))
            {
                NavigationManager.NavigateTo("notfound");
            }
            else
            {
                throw;
            }
        }

        NavigationManager.NavigateTo("/transactions");
    }

    private bool TransactionExists(int id)
    {
        using var context = DbFactory.CreateDbContext();
        return context.Transaction.Any(e => e.Id == id);
    }
}
